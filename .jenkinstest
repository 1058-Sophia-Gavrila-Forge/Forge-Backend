pipeline {
  agent any
  
  
  environment {
      GIT_COMMIT_EMAIL = """${sh (
          script: 'git --no-pager show -s --format=\'%ae\'',
          returnStdout: true
      ).trim()}"""
      GIT_COMMIT_MSG = """${sh (
          script: 'git log -1 --pretty=%B',
          returnStdout: true
      )}"""
      GIT_COMMIT_FED = """${sh (
          script: '[[ $GIT_COMMIT_MSG == *"MAKE FRONTEND-DEV"* ]]',
          returnStdout: true
      )}"""
  }
  
  stages {
    stage('Setup') {
      steps {
        sh 'pwd'
        sh 'ls -al'
        sh 'chmod +x gradlew'
        
      }
    }
    
    stage('list credentials ids') {
      steps {
        script {
          sh 'cat $JENKINS_HOME/credentials.xml | grep "<id>"'
        }
      }
    }
    
    stage("Env Variables") {
        steps {
            sh 'printenv'
        }
    }
    
    stage('Test') {
      steps {
        withGradle {
          script{
            try {
              sh './gradlew build -x test --no-daemon'
              sh './gradlew test jacocoTestReport --no-daemon'
            } finally {
              echo 'junit call can go here'
            }
          } //script
        } //withGradle
      } //steps
    } //stage('Test')
    
    stage('Publish Test Coverage Report') {
      steps {
        step([$class: 'JacocoPublisher',
              execPattern: '**/build/jacoco/*.exec',
              classPattern: '**/build/classes',
              sourcePattern: 'src/main/java',
              exclusionPattern: 'src/test*',
              buildOverBuild: true,
              changeBuildStatus: true
              ])
      } //steps
    } //stage(...)
    
    stage('Record Coverage') {
        when { branch 'main' }
        steps {
            script {
                currentBuild.result = 'SUCCESS'
             }
            step([$class: 'MasterCoverageAction', scmVars: [GIT_URL: env.GIT_URL]])
        }
    }
    stage('PR Coverage to Github') {
        when { 
            not {
                branch 'frontend-dev'
            }; 
            expression { return env.CHANGE_ID != null } 
        }
        steps {
            script {
                currentBuild.result = 'SUCCESS'
             }

            step([$class: 'CompareCoverageAction', publishResultAs: 'statusCheck', scmVars: [GIT_URL: env.GIT_URL]])

        }
    }
    
    stage('Make Frontend-Dev') {
        when { 
               branch 'main' 
               environment name: 'GIT_COMMIT_FED', value: 'true'
        }
        steps {
            echo 'some script to delete frontend-dev branch and remake it from branch main'
        }
    }
    
    stage('Deploy Frontend-Dev') {
        when { 
              branch 'frontend-dev'
        }
        steps {
            script {
                sh './gradlew clean bootRun'
            }
        }
    }
    
  } //stages
  post {
    always {
      emailext body: 'A Test EMail',
               to: env.GIT_COMMIT_EMAIL,
               recipientProviders: [[$class: 'DevelopersRecipientProvider'], 
                                   [$class: 'RequesterRecipientProvider']], 
               subject: 'Test'
    }
  }
}

