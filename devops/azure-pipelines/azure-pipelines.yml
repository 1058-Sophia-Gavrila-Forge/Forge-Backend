trigger:
  - main
  - dev
pr:
  - main
  - dev

pool:
  vmImage: ubuntu-latest

parameters:
  - name: 'branchMain'
    type: string

stages:
  - stage: Build_and_Test
    jobs:
      - template: ./maven-build-test-job-template.yml
        parameters:
          jobName: 'Build_and_Test'
          sonarServiceConnection: 'Forge-SonarCloud'
          sonarOrganization: '1058-sophia-gavrila-forge'
          sonarProjectKey: '1058-Sophia-Gavrila-Forge_Forge-Backend'
          sonarProjectName: 'Forge-Backend'
          testPath: '**/surefire-reports/TEST-*.xml'
          mavenOutput: demo-0.0.1-SNAPSHOT.war
          
  - stage: Dockerize
    jobs:
      - template: ./dockerize-template.yml
        parameters:
          jobName: 'Dockerize'
          containerRegistry: 'project-3-docker-hub'
          repository: 'dajpearl/forge-backend'
          imageTag: "$(Build.SourceVersion)"
          dockerPath: '**/mavenpipe.dockerfile'

  - stage: Deploy
    jobs:
      - template: ./kubernetes-template.yml
        parameters:
          jobName: 'Deploy'
          branchMain: 'refs/heads/azure-pipelines'
          ${{ if eq(variables['Build.SourceBranch'], parameters.branchMain) }}:
            clusterServiceConnection: 'Alex-Main-Cluster'
          ${{ if ne(variables['Build.SourceBranch'], parameters.branchMain) }}:
            clusterServiceConnection: 'Alex-Dev-Cluster'
          manifestPath: '**/backend_manifest.yaml'

      - template: ./discord-job-template.yml
        parameters:
          dependOn: Deploy
          name: 'Team2-P3-Backend'
          title: 'Forge Portfolio Management System DevOps'
          discordVarGroup: Discord-Webhook-Info
            # parameters.discordVarGroup contains the name of a variable group set in Azure Pipelines > Library
            # the variable group contains two variables: discordid and discordkey
            # currently, the discordVarGroup is named Discord-Webhook-Info, 
            # but can be swapped out if you want to notify to multiple Discord webhooks.
